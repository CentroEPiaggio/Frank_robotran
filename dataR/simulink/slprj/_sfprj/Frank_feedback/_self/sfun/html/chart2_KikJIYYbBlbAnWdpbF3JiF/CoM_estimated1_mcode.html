<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">   1</a></span><span class="line"><span class="keyword">function</span> [<span class="var type1" id="S2T6U3">psi</span>, <span class="var type1" id="S3T6U4">psi_dot</span>, <span class="var type1" id="S4T18U5">CoM</span>]  = CoM_estimated(<span class="var type1" id="S5T6U8">psi_1</span>, <span class="var type1" id="S6T16U9">q</span>, <span class="var type1" id="S7T16U10">qd</span>, <span class="var type1" id="S8T16U11">qdd</span>, <span class="var type1" id="S9T1U12">rob_str</span>, <span class="var type1" id="S10T6U13">Ts</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">   2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">   3</a></span><span class="line"><span class="mxinfo" id="T18:U10"><span class="var type1" id="S4T18U16">CoM</span> = <span class="mxinfo" id="T18:U12">zeros(<span class="mxinfo" id="T6:U13">3</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">   4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">   5</a></span><span class="line"><span class="mxinfo" id="T15:U14"><span class="var type1" id="S12T15U23">sens_values</span> = <span class="mxinfo" id="T15:U16">@sensor_measurements</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">   6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">   7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">   8</a></span><span class="line"><span class="comment">% calculate the CoM (x,y,z)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">   9</a></span><span class="line"><span class="mxinfo" id="T6:U17"><span class="var type1" id="S14T6U28">m_tot</span> = <span class="mxinfo" id="T6:U19">sum(<span class="mxinfo" id="T3:U20"><span class="var type1" id="S9T1U32">rob_str</span>.m</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">  10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">  11</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S16T6U36">j</span> = <span class="mxinfo" id="T18:U23"><span class="mxinfo" id="T6:U24">1</span>:3</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">  12</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S17T6U42">i</span> = <span class="mxinfo" id="T23:U26"><span class="mxinfo" id="T6:U27">1</span>:12</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">  13</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">  14</a></span><span class="line">        <span class="mxinfo" id="T17:U28"><span class="var type1" id="S18T17U48">S</span> = <span class="mxinfo" id="T17:U30"><span class="mxinfo" id="T15:U31"><span class="fcn" id="F22N3:B15">sens_values</span></span>(<span class="var type1" id="S6T16U51">q</span>,<span class="var type1" id="S7T16U52">qd</span>,<span class="var type1" id="S8T16U53">qdd</span>,<span class="var type1" id="S9T1U54">rob_str</span>,<span class="var type1" id="S17T6U55">i</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">  15</a></span><span class="line">        <span class="mxinfo" id="T6:U37"><span class="mxinfo" id="T6:U38"><span class="var type1" id="S4T18U59">CoM</span>(<span class="var type1" id="S16T6U60">j</span>)</span> = <span class="mxinfo" id="T6:U41"><span class="mxinfo" id="T6:U42"><span class="var type1" id="S4T18U63">CoM</span>(<span class="var type1" id="S16T6U64">j</span>)</span> + <span class="mxinfo" id="T6:U45">(<span class="mxinfo" id="T6:U46"><span class="mxinfo" id="T6:U47"><span class="mxinfo" id="T3:U48"><span class="var type1" id="S9T1U70">rob_str</span>.m</span>(<span class="mxinfo" id="T6:U50"><span class="var type1" id="S17T6U73">i</span>+<span class="mxinfo" id="T6:U52">5</span></span>)</span>*<span class="mxinfo" id="T6:U53"><span class="mxinfo" id="T18:U54"><span class="var type1" id="S18T17U77">S</span>.P</span>(<span class="var type1" id="S16T6U79">j</span>)</span></span>)/<span class="var type1" id="S14T6U80">m_tot</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">  16</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">  17</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">  18</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">  19</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">  20</a></span><span class="line"><span class="comment">% Ry = [cos(q(5)) 0 sin(q(5)); 0 1 0; -sin(q(5)) 0 cos(q(5))];</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">  21</a></span><span class="line"><span class="comment">% x_ax = [1 0 0]';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">  22</a></span><span class="line"><span class="comment">% z_ax = [0 0 1]';</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">  23</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">  24</a></span><span class="line"><span class="comment">% vedo se cado avanti o indietro </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">  25</a></span><span class="line"><span class="comment">% if(dot(x_ax, CoM./norm(CoM)) &gt;= 0)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">  26</a></span><span class="line"><span class="comment">%     psi = acos(dot(z_ax, CoM./norm(CoM)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">  27</a></span><span class="line"><span class="comment">% else </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">  28</a></span><span class="line"><span class="comment">%     psi = -acos(dot(z_ax, CoM./norm(CoM)));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">  29</a></span><span class="line"><span class="comment">% end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">  30</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">  31</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">  32</a></span><span class="line"><span class="keyword">if</span>(<span class="var type1" id="S4T18U87">CoM</span>(3) &gt; 0 &amp;&amp; <span class="var type1" id="S4T18U92">CoM</span>(1) &gt;= 0)</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">  33</a></span><span class="line">    <span class="mxinfo" id="T6:U60"><span class="var type1" id="S2T6U97">psi</span> = <span class="mxinfo" id="T6:U62"><span class="mxinfo" id="T6:U63">atan2(<span class="mxinfo" id="T6:U64"><span class="mxinfo" id="T6:U65"><span class="var type1" id="S4T18U103">CoM</span>(<span class="mxinfo" id="T6:U67">3</span>)</span>-<span class="mxinfo" id="T6:U68">0.1</span></span>,<span class="mxinfo" id="T6:U69"><span class="var type1" id="S4T18U107">CoM</span>(<span class="mxinfo" id="T6:U71">1</span>)</span>)</span>-<span class="mxinfo" id="T6:U72"><span class="mxinfo" id="T6:U73">pi</span>/<span class="mxinfo" id="T6:U74">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">  34</a></span><span class="line"><span class="keyword">elseif</span>(<span class="var type1" id="S4T18U117">CoM</span>(1) &lt; 0) </span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">  35</a></span><span class="line">    <span class="mxinfo" id="T6:U76"><span class="var type1" id="S2T6U122">psi</span> = <span class="mxinfo" id="T6:U78"><span class="mxinfo" id="T6:U79">-<span class="mxinfo" id="T6:U80">atan2(<span class="mxinfo" id="T6:U81"><span class="mxinfo" id="T6:U82"><span class="var type1" id="S4T18U129">CoM</span>(<span class="mxinfo" id="T6:U84">3</span>)</span>-<span class="mxinfo" id="T6:U85">0.1</span></span>,<span class="mxinfo" id="T6:U86"><span class="var type1" id="S4T18U133">CoM</span>(<span class="mxinfo" id="T6:U88">1</span>)</span>)</span></span> + <span class="mxinfo" id="T6:U89"><span class="mxinfo" id="T6:U90">pi</span>/<span class="mxinfo" id="T6:U91">2</span></span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">  36</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">  37</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">  38</a></span><span class="line"><span class="mxinfo" id="T6:U92"><span class="var type1" id="S3T6U141">psi_dot</span> = <span class="mxinfo" id="T6:U94">(<span class="mxinfo" id="T6:U95"><span class="mxinfo" id="T6:U96"><span class="var type1" id="S2T6U145"><span class="message error" id="M1F1C">psi</span></span></span>-<span class="var type1" id="S5T6U146">psi_1</span></span>)/<span class="var type1" id="S10T6U147">Ts</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">  39</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">  40</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">  41</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">  42</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">  43</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">  44</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">  45</a></span><span class="line"></span></span>
</pre>
